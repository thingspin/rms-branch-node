[{"id":"adb69215.3727a","type":"tab","label":"(지사) 테스트결과 수신","disabled":false,"info":"1. Reference : \n   - MODEL LIST\n   - ALRAM RULE\n   - CPK RULE\n \n2. Calculaton :\n   - CPK per INSPECTION ITEM\n   - ALRAM per INSPECTION ITEM\n   - ALRAM per CHANNEL OF TEST MACHINE\n\n3. Output :\n   - ORIGINAL + CPK TO MSSQL\n   - ALRAM TO MSSQL\n   - ALRAM TO MQTT"},{"id":"ad053556.7d5398","type":"tab","label":"CPK and Alram Calculation","disabled":false,"info":""},{"id":"9f219e3c.e6e46","type":"mqtt-broker","z":"","name":"Local MQTT Broker","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"f2efe6cb.ca58e8","type":"MSSQL-CN","z":"","name":"Local MS-SQL Server","server":"219.251.4.237","encyption":false,"database":"thingspin-v0"},{"id":"1dc9e4a.7d2ed1b","type":"influxdb","z":"","hostname":"219.251.4.237","port":"8086","protocol":"http","database":"thingspin","name":"rms-branch-influxdb","usetls":false,"tls":""},{"id":"6b8aec03.743554","type":"mqtt-broker","z":"","name":"MQTT(RMS BRANCH)","broker":"219.251.4.237","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willRetain":"true","willPayload":"","birthTopic":"","birthQos":"2","birthRetain":"true","birthPayload":""},{"id":"35d824ed.29e69c","type":"influxdb","z":"","hostname":"localhost","port":"8086","protocol":"http","database":"thingspin","name":"rms-branch-influxdb","usetls":false,"tls":""},{"id":"d2adcd4a.3d58f","type":"mqtt-broker","z":"","name":"MQTT(CENTER) Broker","broker":"219.251.4.236","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"98351f84.bbf9f","type":"mqtt-broker","z":"","name":"MQTT(CENTER) Broker","broker":"219.251.4.236","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"2","birthRetain":"true","birthPayload":""},{"id":"bfa3a0f6.8b468","type":"mqtt in","z":"adb69215.3727a","name":"+/INSPT/+/+ __","topic":"+/INSPT/+/+","qos":"0","broker":"6b8aec03.743554","x":142.16668701171875,"y":806.0000410079956,"wires":[["157cec35.353fd4"]]},{"id":"157cec35.353fd4","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":338.16669845581055,"y":832.6668691635132,"wires":[["2bc9117c.ccb2ee"]]},{"id":"53d6c99.ac49338","type":"mqtt in","z":"adb69215.3727a","name":"+/INSPTDEV/+/+","topic":"+/INSPTDEV/+/+","qos":"0","broker":"6b8aec03.743554","x":142,"y":861.6667098999023,"wires":[["157cec35.353fd4"]]},{"id":"3576657f.c54c2a","type":"inject","z":"adb69215.3727a","name":"","topic":"","payload":"","payloadType":"date","repeat":"3600","crontab":"","once":false,"onceDelay":0.1,"x":129,"y":211,"wires":[["b003628a.38386"]]},{"id":"b003628a.38386","type":"function","z":"adb69215.3727a","name":"YYYYMMDD","func":"Date.prototype.yyyymmdd = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n\n  return [this.getFullYear(),\n          (mm>9 ? '' : '0') + mm,\n          (dd>9 ? '' : '0') + dd\n         ].join('');\n};\n\nvar date = new Date();\ndate.yyyymmdd();\n\n//global.set(\"YYYYMMDD\", date.yyyymmdd());\nglobal.set(\"YYYYMMDD\", \"20180101\");\n\nreturn;","outputs":1,"noerr":0,"x":299,"y":211,"wires":[[]]},{"id":"88c1b025.12d23","type":"inject","z":"adb69215.3727a","name":"reset globals","topic":"thingspin","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":128,"y":96,"wires":[["e94a6823.7fb7b8"]]},{"id":"e94a6823.7fb7b8","type":"function","z":"adb69215.3727a","name":"reset globals","func":"global.set(\"INSPPROP\", null);\nglobal.set(\"ACTINADV\", null);\n\nmsg.payload = \"global context reset!\";\n\nreturn msg;","outputs":1,"noerr":0,"x":302,"y":96,"wires":[["49682169.6a632","c6a3465.9cd78b8"]]},{"id":"f8f51a31.6c6528","type":"comment","z":"adb69215.3727a","name":"[저장소 이름을 구분하기 위해 YYYYMMDD를 생성___]","info":"","x":185,"y":175,"wires":[]},{"id":"d5401c38.fe64","type":"comment","z":"adb69215.3727a","name":"[관리자용 내부변수 초기화______________________]","info":"","x":185,"y":58,"wires":[]},{"id":"e8a68ffb.25896","type":"comment","z":"adb69215.3727a","name":"[시험결과를 받아 DB 포맷으로 변경 ___________________________________]","info":"","x":290,"y":761.6666860580444,"wires":[]},{"id":"2bc9117c.ccb2ee","type":"function","z":"adb69215.3727a","name":"RECORDS","func":"//=========================================================\nvar YYYYMMDD = global.get(\"YYYYMMDD\");\nvar inspprop = global.get(\"INSPPROP\");\n\nif (!YYYYMMDD) {\n    return;\n}\n\nvar mesINSP = `inspection.summary-${YYYYMMDD}`;\nvar mesDETL = `inspection.detail-${YYYYMMDD}`;\n\n//=========================================================\nvar details = msg.payload.details;\ndelete msg.payload.details;\n\nvar tocken = msg.topic.split(\"/\");\nmsg.payload.pcID  = tocken[2];\nmsg.payload.channel = tocken[3];\n\nvar inspection = msg.payload;\n\nif(!inspection.prodModel)\n{\n    return null;\n}\n\n//=========================================================\ninspection = {\n    measurement: mesINSP,\n    tags: {\n        facility: inspection.pcID,\n        channel: inspection.channel,\n        model: inspection.prodModel,\n        pass: inspection.pass\n    },\n    fields: {\n        tuid: msg._msgid,\n        stime: inspection.startTime,\n        etime: inspection.endTime\n    }    \n};\n\n//=========================================================\nvar transaction = details.map(\n    function(point) {\n        var inm = \"\";\n        var i = inspprop.get(point.iid);\n        if (!i) {\n            inm = point.iid + \"\";\n        } else {\n            inm = i.NAME;\n        }\n        \n        return {\n            measurement: mesDETL,\n            tags : {\n                facility: msg.payload.pcID,\n                channel: msg.payload.channel,\n                model: msg.payload.prodModel,\n                pass: point.pass,                \n                iid: point.iid,\n                inm: inm                \n            },\n            fields: {\n                tuid: msg._msgid,\n                val: point.val,\n                min: point.min,\n                max: point.max\n            }\n        };\n    }\n);\n\ntransaction.unshift(inspection);\n\n//=========================================================\nmsg.payload = transaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":831.6666860580444,"wires":[["69bb37cb.2f81a8"]]},{"id":"69bb37cb.2f81a8","type":"link out","z":"adb69215.3727a","name":"inspection-results-out","links":[],"x":956,"y":829.6666870117188,"wires":[]},{"id":"80deef68.7157d","type":"comment","z":"adb69215.3727a","name":"To CPK 계산","info":"","x":717.0000610351562,"y":832.6666870117188,"wires":[]},{"id":"49682169.6a632","type":"link out","z":"adb69215.3727a","name":"reset-out","links":["3fd3dba8.5934f4"],"x":760,"y":95,"wires":[]},{"id":"f62c24af.8213a8","type":"comment","z":"ad053556.7d5398","name":"[ 플로우 변수 초기화 ______________________]","info":"","x":175,"y":20,"wires":[]},{"id":"91c8e20d.ec771","type":"link in","z":"ad053556.7d5398","name":"inspection-result-receive","links":["84b6d1b4.68d31"],"x":48.00004577636719,"y":157,"wires":[["dc32119.8f462f"]]},{"id":"dc32119.8f462f","type":"function","z":"ad053556.7d5398","name":"CEP","func":"var sa = global.get(\"stats-analysis\");\nvar sm = global.get(\"statistical-methods\");\nvar cepT = flow.get(\"cepTABLE\");\nif (!cepT) {\n    node.warn(\"CEP context (cepT) being intialized...\");\n    cepT = new Map();\n    flow.set(\"cepTABLE\", cepT);\n}\n\nvar head = msg.payload.shift();\nvar keyCH = `${head.tags.facility}:${head.tags.channel}`;\nvar keyMD = `${keyCH}:${head.tags.model}`;\n\nfunction __cpk(spec, v) {\n    const m = sa.mean(v);\n    let sigma = sa.stdev(v);\n    if(sigma === 0 || v.length < 5) {\n        return  {\n            cpk: (spec.usl + spec.lsl) / 2,\n            cp: (spec.usl + spec.lsl) / 2\n        }\n    }\n\n    const u = (spec.usl - m) / (3*sigma);\n    \n    let cpk;\n    if (!spec.lsl) {\n        cpk = {\n            cpk: u,\n            cp: u/2\n        }\n    } else {\n        var l = (m - spec.lsl) / (3*sigma);\n        cpk = {\n            cpk: sm.min([l, u]),\n            cp: (spec.usl - spec.lsl) / (6*sigma)\n        }\n    }\n    \n    if(!cpk.cp) cpk.cp = m;\n    if(!cpk.cpk) cpk.cpk = m;\n\n    return cpk;\n}\n\nfunction _cpk(cep, k, so) {\n    \n    var saved = cep.get(k);\n\n    var val = saved.map( (s) => {\n        return s.fields.val;\n    });\n\n    if (val.length <= 1) {\n        val.push(so.fields.val);\n    }\n    \n    var spec = {\n        lsl: so.fields.min, //sm.min(que.val),\n        usl: so.fields.max, //sm.max(que.val),\n    };\n\n    var c = __cpk(spec, val);\n\n    so.fields.cp = c.cp;\n    so.fields.cpk = c.cpk;\n    so.fields.usl = spec.usl;\n    so.fields.lsl = spec.lsl;\n    \n    return so;\n}\n\nfunction _store(cep, so) {\n    var key = `${so.tags.iid}:${keyCH}`;\n    \n    so.key = key;\n    so.tags.fireCNF = false;\n    so.tags.fireCPK = false;\n    \n    so.fields.acc = (so.tags.pass === true) ? 0.0 : 1.0;\n    so.fields.acum = 1.0;\n    \n    var isin = cep.has(key);\n    if(!isin) {\n        cep.set(key, [so]);\n    } else {\n        var p = cep.get(key);\n        so.fields.acc = (so.tags.pass === true) ? 0.0 : parseInt(p[0].fields.acc) + 1.0;\n        so.fields.acum = parseInt(p[0].fields.acum) + 1.0;\n\n        if( p.length > 50 ) { // queue limit !\n            p.pop();\n        }\n        \n        p.unshift(so);\n        cep.set(key, p);\n    }\n\n    flow.set(\"cepTABLE\", cep);\n\n    return {key:key, so:so};\n}\n\nfunction _convAlert(str) {\n    let retVal;\n    switch(str) {\n        case \"안함\":     retVal = 0; break;\n        case \"알람\":     retVal = 1; break;\n        case \"라인정지\": retVal = 2; break;\n        default:\n            retVal = null;\n    }\n    return retVal;\n}\n\n//===========================================================================\n// GET CPK\n//===========================================================================\nvar proc = msg.payload.map( (so) => {\n    var kso = _store(cepT, so);\n    \n    return _cpk(cepT, kso.key, kso.so);\n});\n\n//===========================================================================\n// GET ALRAM\n//===========================================================================\nlet undefinedAlarm = [];\nfunction _alram(cep, rule, head, sos) {\n    const hits = [];\n    rule.forEach( (r) => {\n        const targets = sos.filter ( (so) => {\n            return (r.INSPPROP_ID === 0 || r.INSPPROP_ID === so.tags.iid);\n        });\n        \n        const cf = r.CONT_FAIL;\n        const cpk = r.CPK;\n\n        // 연속 뷸량 검출 || CPK 위반 검출\n        if (cf || cpk) {\n            const cmax = parseInt(cf.COUNT);\n\n            targets.map( (so) => {\n                let _so = Object.assign({}, so);\n                _so.fields.cmax = cmax;                \n                //node.warn(\"test:\" + cmax + \" with:\" +so.fields.acc + \" IN: \" + so.tags.facility + \":\" + so.tags.channel + \" : \" + so.fields.inm + \": \" + so.tags.model + \": \" + so.tags.pass);\n\n                if(cpk) {\n                    if( (_so.fields.cpk < cpk.LSL) || (_so.fields.cpk > cpk.USL) ) {\n                        const alertNum = _convAlert(cpk.ACTION);\n                        if ( alertNum === 2 ) {\n                            _so.rule = r;\n                        }\n                        \n                        if( _so.fields.acc >= cmax) {\n                            _so.tags.alert = alertNum;\n                        }\n\n                        _so.output = 2;\n                        _so.fields.lsl_min = cpk.LSL;\n                        _so.fields.usl_max = cpk.USL;                    \n                        _so.tags.fireCPK = true;\n                        \n                        if (alertNum === null) {\n                            undefinedAlarm.push(_so);\n                        } else {\n                            hits.push(_so);\n                        }\n                    }\n                }\n                \n                if(cf) {\n                    if( _so.fields.acc >= cmax) {\n                        const alertNum = _convAlert(cf.ACTION);\n                        if ( alertNum === 2 ) {\n                            _so.rule = r;\n                        }\n\n                        _so.tags.alert = alertNum;\n                        _so.tags.fireCNF = true;\n    \n                        _so.output = 1;\n                        if (alertNum === null) {\n                            undefinedAlarm.push(_so);\n                        } else {\n                            hits.push(_so);\n                        }\n                        \n                        let p = cep.get(_so.key);\n                        let s = p.shift();\n                        s.fields.acc = 0; // accumulator clear\n                        p.unshift(s);\n                        cep.set(_so.key, p);\n                    }\n                }\n            })\n        }\n    });\n    \n    return hits;\n}\nlet ruleT = global.get(\"ACTINADV\");\nif (!ruleT) {\n    node.error(\"A CEP (CPK calculation and monitoring & Continuos failure detection rule is not yet set!\");\n    ruleT = new Map();\n    global.set(\"ACTINADV\", ruleT);\n}\nlet alram = _alram(cepT, ruleT, head, proc);\n\n//===========================================================================\n// MAIN RETURN\n//===========================================================================\n\nproc.unshift(head);\nmsg.payload = proc;\n\ndelete alram.key;\n\nvar a = {\n    legth: alram.length,\n    payload: alram,\n};\n\nreturn [\n    msg, \n    (a.legth === 0) ? null : a\n];\n","outputs":2,"noerr":0,"x":167.0000457763672,"y":157,"wires":[["b9633728.b46698"],["f8f8be5.c8c844"]]},{"id":"3fd3dba8.5934f4","type":"link in","z":"ad053556.7d5398","name":"reset-cpk-flow-in","links":["49682169.6a632"],"x":51,"y":61,"wires":[["20fa2615.aca4fa"]]},{"id":"20fa2615.aca4fa","type":"function","z":"ad053556.7d5398","name":"reset flow","func":"flow.set(\"cepTABLE\", null);\n\nmsg.payload = \"flow context reset!\";\n\nreturn msg;","outputs":1,"noerr":0,"x":538,"y":58,"wires":[["28991bef.e15004"]]},{"id":"8b410c30.e6c5b","type":"inject","z":"ad053556.7d5398","name":"reset-flow","topic":"air\\SQLEXPRESS","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":61,"wires":[["20fa2615.aca4fa"]]},{"id":"79415cdd.aa1504","type":"comment","z":"ad053556.7d5398","name":"[시험결과 연속불량과 CPK 계산_____________]","info":"","x":175,"y":102,"wires":[]},{"id":"f8f8be5.c8c844","type":"function","z":"ad053556.7d5398","name":"알람 (경고, 라인정지)","func":"//=========================================================\nconst YYYYMMDD = global.get(\"YYYYMMDD\");\n\nif (!YYYYMMDD) {\n    return;\n}\n\nvar linestop = [];\nvar alerts = [];\nmsg.payload.map((a) => {\n    switch (a.output) {\n        case 1: a.measurement = `alram.continuous.failures.detail-${YYYYMMDD}`; break;\n        case 2: a.measurement = `alram.cpk.detail-${YYYYMMDD}`; break;\n        default:\n            // node.warn(`unknown Output ${a.output}`);\n            // node.warn(a);\n    }\n\n    if( a.tags.alert === 2 ) { // 라인정지\n        linestop.push(a);\n        alerts.push(a);\n    } else if ( a.tags.alert === 1 ) {\n        alerts.push(a);\n    }\n\n    delete a.key;\n    delete a.output;\n});\n\nreturn [alerts, linestop];","outputs":2,"noerr":0,"x":411.0001220703125,"y":196,"wires":[["f3d07f8e.bd40d"],["1cf736e0.fbc429"]]},{"id":"28991bef.e15004","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":723.1666870117188,"y":58.66667175292969,"wires":[]},{"id":"c6a3465.9cd78b8","type":"debug","z":"adb69215.3727a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":631.1666870117188,"y":95.66667175292969,"wires":[]},{"id":"e8d1b2cd.57e77","type":"mqtt in","z":"adb69215.3727a","name":"INSPPROP/#","topic":"INSPPROP/#","qos":"2","broker":"d2adcd4a.3d58f","x":127,"y":315,"wires":[["dae9bf8b.10d0e"]]},{"id":"1ff7974e.561709","type":"debug","z":"adb69215.3727a","name":"LOG: 검사항목","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":873,"y":350,"wires":[]},{"id":"59f82040.4ca0a","type":"mqtt in","z":"adb69215.3727a","name":"ACTINADV/#","topic":"ACTINADV/#","qos":"2","broker":"d2adcd4a.3d58f","x":126.00003051757812,"y":436.0000057220459,"wires":[["1978c978.0f53a7"]]},{"id":"d893c63d.428ed8","type":"debug","z":"adb69215.3727a","name":"LOG: 조치 룰","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":862.0000076293945,"y":481.0000057220459,"wires":[]},{"id":"ea55a10b.b1db4","type":"function","z":"adb69215.3727a","name":"Store in Global","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"INSPPROP\") {\n        msg.payload.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg.payload) !== true) {\n    return;\n}\n\nvar prop = msg.payload;\n\nvar map = global.get(\"INSPPROP\");\n\nif(map === null) {\n    map = new Map();\n}\n\nmap.set(prop.ID, prop);\n\nglobal.set(\"INSPPROP\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":664,"y":310,"wires":[["1ff7974e.561709"]]},{"id":"e59b6a9d.93c318","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":503,"y":309,"wires":[["ea55a10b.b1db4"]]},{"id":"a2e6abab.30ce48","type":"comment","z":"adb69215.3727a","name":"[검사항목리스트를 FLOW 컨텍스트에 저장_________]","info":"","x":185,"y":274,"wires":[]},{"id":"cdb4a45b.53b4f8","type":"comment","z":"adb69215.3727a","name":"[사전조치 항목: 연속불량 알림 계산 룰, CPK 계속 룰을  FLOW 컨텍스트에 저장]","info":"","x":255,"y":399.0000305175781,"wires":[]},{"id":"81249e99.8757e","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":498.0000305175781,"y":436,"wires":[["5b4d44a8.e4a37c"]]},{"id":"5b4d44a8.e4a37c","type":"function","z":"adb69215.3727a","name":"Store in Global","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"ACTINADV\") {\n        msg.payload.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg.payload) !== true) {\n    return;\n}\n\nvar prop = msg.payload;\n\nvar map = global.get(\"ACTINADV\");\nif(!map) {\n    map = new Map();\n}\nmap.set(prop.ID, prop);\n\nglobal.set(\"ACTINADV\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":670.0000076293945,"y":436.0000057220459,"wires":[["d893c63d.428ed8"]]},{"id":"1978c978.0f53a7","type":"function","z":"adb69215.3727a","name":"removed ?","func":"var add = null;\nvar del = null;\n\nif (msg.payload === \"\") {\n    del = msg;\n} else {\n    add = msg;\n}\n\nreturn [add, del];","outputs":2,"noerr":0,"x":318.0000305175781,"y":436,"wires":[["81249e99.8757e"],["309e94a1.28cdac"]]},{"id":"309e94a1.28cdac","type":"function","z":"adb69215.3727a","name":"del","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"ACTINADV\") {\n        msg.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg) !== true) {\n    return;\n}\n\nvar map = global.get(\"ACTINADV\");\n\nif(map === null) {\n    map = new Map();\n}\n\nmap.delete(msg.ID);\n\nglobal.set(\"ACTINADV\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":498.0000686645508,"y":481.0000057220459,"wires":[["d893c63d.428ed8"]]},{"id":"dae9bf8b.10d0e","type":"function","z":"adb69215.3727a","name":"removed ?","func":"var add = null;\nvar del = null;\n\nif (msg.payload === \"\") {\n    del = msg;\n} else {\n    add = msg;\n}\n\nreturn [add, del];","outputs":2,"noerr":0,"x":336,"y":315,"wires":[["e59b6a9d.93c318"],["6d5e0586.b7c46c"]]},{"id":"6d5e0586.b7c46c","type":"function","z":"adb69215.3727a","name":"del","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"INSPPROP\") {\n        msg.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg) !== true) {\n    return;\n}\n\nvar map = global.get(\"INSPPROP\");\n\nif(map === null) {\n    map = new Map();\n}\n\nmap.delete(msg.ID);\n\nglobal.set(\"INSPPROP\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":503,"y":351,"wires":[["1ff7974e.561709"]]},{"id":"cec1143c.7a0128","type":"mqtt in","z":"adb69215.3727a","name":"THINGSPIN/MODELS","topic":"THINGSPIN/MODELS","qos":"0","broker":"9f219e3c.e6e46","x":140,"y":1026,"wires":[["4f1b25f4.e3e27c"]]},{"id":"96ee076b.f6f788","type":"debug","z":"adb69215.3727a","name":"LOG: 모델리스트","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":904.0000228881836,"y":1026.0001125335693,"wires":[]},{"id":"4f1b25f4.e3e27c","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":424.00001525878906,"y":1027.0000305175781,"wires":[["96ee076b.f6f788"]]},{"id":"9a784a6e.1970b8","type":"comment","z":"adb69215.3727a","name":"[모델리스트_____________________________]","info":"","x":190,"y":963,"wires":[]},{"id":"f3d07f8e.bd40d","type":"link out","z":"ad053556.7d5398","name":"out-alerts","links":["ce250005.b957"],"x":562.166748046875,"y":179.6666717529297,"wires":[]},{"id":"1cf736e0.fbc429","type":"link out","z":"ad053556.7d5398","name":"out-linestop","links":["3ef68ee5.6d0df2"],"x":564.1668701171875,"y":213.66668701171875,"wires":[]},{"id":"ce250005.b957","type":"link in","z":"ad053556.7d5398","name":"","links":["f3d07f8e.bd40d"],"x":59.166709899902344,"y":270.33338928222656,"wires":[["32373b91.68e474","a3715a32.a6dcb8"]]},{"id":"3ef68ee5.6d0df2","type":"link in","z":"ad053556.7d5398","name":"","links":["1cf736e0.fbc429"],"x":54.166704177856445,"y":420.3333740234375,"wires":[["98c5349e.054a88","998ff7f1.4386e8"]]},{"id":"9bbcdf93.1bd94","type":"comment","z":"ad053556.7d5398","name":"[ 경고 발행   ______ ______________________]","info":"","x":165,"y":231,"wires":[]},{"id":"de13087c.4bec48","type":"comment","z":"ad053556.7d5398","name":"[ 라인정지 발행 __________________________]","info":"","x":175,"y":369,"wires":[]},{"id":"32373b91.68e474","type":"function","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/ALERT","func":"msg.topic = \"THINGSPIN/EMERGENCY/ALERT\";\nmsg.payload = {\n    tags: msg.tags,    \n    fields: msg.fields,\n};\ndelete msg.tags;\ndelete msg.fields;\ndelete msg.measurement;\n\nreturn msg;","outputs":1,"noerr":0,"x":312.0000457763672,"y":269.00006103515625,"wires":[["11a336ba.d08349","7be02c34.e9cdf4"]]},{"id":"98c5349e.054a88","type":"function","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/LINESTOP","func":"msg.topic = \"THINGSPIN/EMERGENCY/LINESTOP\";\nmsg.payload = {\n    tags: msg.tags,    \n    fields: msg.fields,\n    rule: msg.rule,\n};\ndelete msg.tags;\ndelete msg.fields;\ndelete msg.measurement;\n\nreturn msg;","outputs":1,"noerr":0,"x":320.0000457763672,"y":408,"wires":[["4cadef75.ac422","a57f0ad3.0d13a8"]]},{"id":"11a336ba.d08349","type":"mqtt out","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/ALERT","topic":"THINGSPIN/EMERGENCY/ALERT","qos":"0","retain":"true","broker":"9f219e3c.e6e46","x":657.0000610351562,"y":268.00006103515625,"wires":[]},{"id":"4cadef75.ac422","type":"mqtt out","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/LINESTOP","topic":"THINGSPIN/EMERGENCY/LINESTOP","qos":"0","retain":"false","broker":"9f219e3c.e6e46","x":669.0000610351562,"y":407,"wires":[]},{"id":"7be02c34.e9cdf4","type":"debug","z":"ad053556.7d5398","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":896,"y":266.00006103515625,"wires":[]},{"id":"a57f0ad3.0d13a8","type":"debug","z":"ad053556.7d5398","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":894,"y":404,"wires":[]},{"id":"64badf23.a81ab","type":"comment","z":"ad053556.7d5398","name":"[ 경고]","info":"","x":632.000244140625,"y":180,"wires":[]},{"id":"fc8c9560.021e38","type":"comment","z":"ad053556.7d5398","name":"[ 라인정지]","info":"","x":645.0001220703125,"y":213,"wires":[]},{"id":"91029ca7.1d7dd","type":"comment","z":"ad053556.7d5398","name":"[ 모든 계산된 결과 레코드]","info":"","x":643.0001831054688,"y":143.00006103515625,"wires":[]},{"id":"3d4a1d66.9d0362","type":"config","z":"ad053556.7d5398","name":"init flow","properties":[{"p":"cepTABLE","pt":"flow","to":"null","tot":"json"}],"active":true,"x":348.5,"y":60,"wires":[]},{"id":"c528bff6.c431","type":"config","z":"adb69215.3727a","name":"reset globals","properties":[{"p":"INSPPROP","pt":"global","to":"null","tot":"json"},{"p":"ACTINADV","pt":"global","to":"null","tot":"json"}],"active":true,"x":126,"y":133,"wires":[]},{"id":"a3715a32.a6dcb8","type":"function","z":"ad053556.7d5398","name":"set alert-yyyymmdd InfluxDB","func":"let YYYYMMDD = global.get(\"YYYYMMDD\");\n\nif (!YYYYMMDD) {\n    YYYYMMDD = \"20180101\";\n}\n\nmsg.payload = [{\n    measurement: `alert-${YYYYMMDD}`,\n    tags: msg.tags,\n    fields: msg.fields,\n}]\n\ndelete msg.tags;\ndelete msg.fields;\n\nreturn msg;","outputs":1,"noerr":0,"x":285.50003814697266,"y":327.0000400543213,"wires":[["b023cc8f.dbb66","317a0724.2004c8"]]},{"id":"b023cc8f.dbb66","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":896,"y":330,"wires":[]},{"id":"998ff7f1.4386e8","type":"function","z":"ad053556.7d5398","name":"set linestop-yyyymmdd InfluxDB","func":"let YYYYMMDD = global.get(\"YYYYMMDD\");\n\nif (!YYYYMMDD) {\n    YYYYMMDD = \"20180101\";\n}\n\nmsg.payload = [{\n    measurement: `linestop-${YYYYMMDD}`,\n    tags: msg.tags,\n    fields: msg.fields,\n}]\n\nreturn msg;","outputs":1,"noerr":0,"x":301.0000305175781,"y":455,"wires":[["2a55ed59.e9bb62","2eb04d00.c171d4"]]},{"id":"2a55ed59.e9bb62","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":895.5,"y":454,"wires":[]},{"id":"317a0724.2004c8","type":"influxdb batch","z":"ad053556.7d5398","influxdb":"35d824ed.29e69c","precision":"ms","retentionPolicy":"","name":"","x":619.0001220703125,"y":328.0000305175781,"wires":[]},{"id":"2eb04d00.c171d4","type":"influxdb batch","z":"ad053556.7d5398","influxdb":"35d824ed.29e69c","precision":"ms","retentionPolicy":"","name":"","x":623.0000610351562,"y":455,"wires":[]},{"id":"b9633728.b46698","type":"influxdb batch","z":"ad053556.7d5398","influxdb":"35d824ed.29e69c","precision":"ms","retentionPolicy":"","name":"","x":421.00006103515625,"y":143,"wires":[]},{"id":"38af05d2.64980a","type":"mqtt in","z":"ad053556.7d5398","name":"+/INSPT/+/+ __","topic":"+/INSPT/+/+","qos":"0","broker":"6b8aec03.743554","x":116.16668701171875,"y":530,"wires":[["3fede3f.041921c"]]},{"id":"3fede3f.041921c","type":"json","z":"ad053556.7d5398","name":"","property":"payload","action":"","pretty":false,"x":301.16668701171875,"y":552,"wires":[["f1514b90.8be8b8"]]},{"id":"3b92d922.82d266","type":"mqtt in","z":"ad053556.7d5398","name":"+/INSPTDEV/+/+","topic":"+/INSPTDEV/+/+","qos":"0","broker":"6b8aec03.743554","x":116.16668701171875,"y":590,"wires":[["3fede3f.041921c"]]},{"id":"d1c4d3ae.87d4","type":"comment","z":"ad053556.7d5398","name":"[시험결과를 받아 DB 포맷으로 변경 ___________________________________]","info":"","x":255,"y":494.6666450500488,"wires":[]},{"id":"f1514b90.8be8b8","type":"function","z":"ad053556.7d5398","name":"RECORDS","func":"//=========================================================\nvar YYYYMMDD = global.get(\"YYYYMMDD\");\nvar inspprop = global.get(\"INSPPROP\");\n\nif (!YYYYMMDD) {\n    return;\n}\n\nvar mesINSP = `inspection.summary-${YYYYMMDD}`;\nvar mesDETL = `inspection.detail-${YYYYMMDD}`;\n\n//=========================================================\nvar details = msg.payload.details;\ndelete msg.payload.details;\n\nvar tocken = msg.topic.split(\"/\");\nmsg.payload.pcID = tocken[2];\nmsg.payload.channel = tocken[3];\n\nvar inspection = msg.payload;\n\nif(!inspection.prodModel)\n{\n    return null;\n}\n\n//=========================================================\ninspection = {\n    measurement: mesINSP,\n    tags: {\n        branch: \"KR\",\n        process: tocken[0],\n        facility: inspection.pcID,\n        channel: inspection.channel,\n        model: inspection.prodModel,\n        pass: inspection.pass\n    },\n    fields: {\n        tuid: msg._msgid,\n        stime: inspection.startTime,\n        etime: inspection.endTime\n    }    \n};\n\n//=========================================================\nvar transaction = details.map(\n    function(point) {\n        var inm = \"\";\n        var i = inspprop.get(point.iid);\n        if (!i) {\n            inm = point.iid + \"\";\n        } else {\n            inm = i.NAME;\n        }\n        \n        return {\n            measurement: mesDETL,\n            tags : {\n                branch: tocken[0],\n                process: tocken[1],                \n                facility: msg.payload.pcID,\n                channel: msg.payload.channel,\n                model: msg.payload.prodModel,\n                pass: point.pass,                \n                iid: point.iid,\n                inm: inm\n            },\n            fields: {\n                tuid: msg._msgid,\n                val: point.val,\n                min: point.min,\n                max: point.max\n            }\n\n        };\n    }\n);\n\ntransaction.unshift(inspection);\n\n//=========================================================\nmsg.payload = transaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":453.16668701171875,"y":552,"wires":[["2a8bf7fd.d75be8","698b29af.9c0c98"]]},{"id":"2a8bf7fd.d75be8","type":"link out","z":"ad053556.7d5398","name":"inspection-results-out","links":["3bf38af5.832ce6"],"x":570.1666870117188,"y":552,"wires":[]},{"id":"e2308e9d.63dad","type":"comment","z":"ad053556.7d5398","name":"To CPK 계산","info":"","x":658.1666870117188,"y":552,"wires":[]},{"id":"698b29af.9c0c98","type":"debug","z":"ad053556.7d5398","name":"RECORDS","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":917.1666870117188,"y":546,"wires":[]},{"id":"3e3c1694.321cda","type":"mqtt in","z":"adb69215.3727a","name":"+/INSPT/+/+ __","topic":"+/INSPT/+/+","qos":"0","broker":"98351f84.bbf9f","x":87.16668701171875,"y":560.3333549499512,"wires":[["4a6a5b26.8283c4"]]},{"id":"4a6a5b26.8283c4","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":297.16668701171875,"y":580.3333549499512,"wires":[["a24fce0c.25a38"]]},{"id":"58231716.a16c68","type":"mqtt in","z":"adb69215.3727a","name":"+/INSPTDEV/+/+","topic":"+/INSPTDEV/+/+","qos":"0","broker":"98351f84.bbf9f","x":87.16668701171875,"y":620.3333549499512,"wires":[["4a6a5b26.8283c4"]]},{"id":"ff44f49f.e7a7f8","type":"comment","z":"adb69215.3727a","name":"[시험결과를 받아 DB 포맷으로 변경 ___________________________________]","info":"","x":255,"y":516,"wires":[]},{"id":"a24fce0c.25a38","type":"function","z":"adb69215.3727a","name":"RECORDS","func":"//=========================================================\nvar YYYYMMDD = global.get(\"YYYYMMDD\");\nvar inspprop = global.get(\"INSPPROP\");\n\nif (!YYYYMMDD) {\n    return;\n}\n\nvar mesINSP = `inspection.summary-${YYYYMMDD}`;\nvar mesDETL = `inspection.detail-${YYYYMMDD}`;\n\n//=========================================================\nvar details = msg.payload.details;\ndelete msg.payload.details;\n\nvar tocken = msg.topic.split(\"/\");\nmsg.payload.pcID = tocken[2];\nmsg.payload.channel = tocken[3];\n\nvar inspection = msg.payload;\n\nif(!inspection.prodModel)\n{\n    return null;\n}\n\n//=========================================================\ninspection = {\n    measurement: mesINSP,\n    tags: {\n        branch: \"KR\",\n        process: tocken[0],\n        facility: inspection.pcID,\n        channel: inspection.channel,\n        model: inspection.prodModel,\n        pass: inspection.pass\n    },\n    fields: {\n        tuid: msg._msgid,\n        stime: inspection.startTime,\n        etime: inspection.endTime\n    }    \n};\n\n//=========================================================\nvar transaction = details.map(\n    function(point) {\n        var inm = \"\";\n        var i = inspprop.get(point.iid);\n        if (!i) {\n            inm = point.iid + \"\";\n        } else {\n            inm = i.NAME;\n        }\n        \n        return {\n            measurement: mesDETL,\n            tags : {\n                branch: tocken[0],\n                process: tocken[1],                \n                facility: msg.payload.pcID,\n                channel: msg.payload.channel,\n                model: msg.payload.prodModel,\n                pass: point.pass,                \n                iid: point.iid,\n                inm: inm\n            },\n            fields: {\n                tuid: msg._msgid,\n                val: point.val,\n                min: point.min,\n                max: point.max\n            }\n\n        };\n    }\n);\n\ntransaction.unshift(inspection);\n\n//=========================================================\nmsg.payload = transaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":497.16668701171875,"y":580.3333549499512,"wires":[["84b6d1b4.68d31","e7a2e784.bbb628"]]},{"id":"84b6d1b4.68d31","type":"link out","z":"adb69215.3727a","name":"inspection-results-out","links":["91c8e20d.ec771"],"x":962.1666870117188,"y":580.3333549499512,"wires":[]},{"id":"b0bb8a58.48c458","type":"comment","z":"adb69215.3727a","name":"To CPK 계산","info":"","x":817.1666870117188,"y":580.3333549499512,"wires":[]},{"id":"e7a2e784.bbb628","type":"debug","z":"adb69215.3727a","name":"RECORDS","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":857.1666870117188,"y":620.3333549499512,"wires":[]}]