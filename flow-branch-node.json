[{"id":"d4a9e4d7.d2ec48","type":"tab","label":"(지사) MQTT Topics Logging","disabled":true,"info":""},{"id":"adb69215.3727a","type":"tab","label":"(지사) 테스트결과 수신","disabled":false,"info":"1. Reference : \n   - MODEL LIST\n   - ALRAM RULE\n   - CPK RULE\n \n2. Calculaton :\n   - CPK per INSPECTION ITEM\n   - ALRAM per INSPECTION ITEM\n   - ALRAM per CHANNEL OF TEST MACHINE\n\n3. Output :\n   - ORIGINAL + CPK TO MSSQL\n   - ALRAM TO MSSQL\n   - ALRAM TO MQTT"},{"id":"ad053556.7d5398","type":"tab","label":"CPK and Alram Calculation","disabled":false,"info":""},{"id":"9f219e3c.e6e46","type":"mqtt-broker","z":"","name":"Local MQTT Broker","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"f2efe6cb.ca58e8","type":"MSSQL-CN","z":"","name":"Local MS-SQL Server","server":"219.251.4.237","encyption":false,"database":"thingspin-v0"},{"id":"1dc9e4a.7d2ed1b","type":"influxdb","z":"","hostname":"219.251.4.237","port":"8086","protocol":"http","database":"thingspin","name":"rms-branch-influxdb","usetls":false,"tls":""},{"id":"6b8aec03.743554","type":"mqtt-broker","z":"","name":"MQTT(RMS BRANCH)","broker":"219.251.4.237","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willRetain":"true","willPayload":"","birthTopic":"","birthQos":"2","birthRetain":"true","birthPayload":""},{"id":"35d824ed.29e69c","type":"influxdb","z":"","hostname":"localhost","port":"8086","protocol":"http","database":"thingspin","name":"rms-branch-influxdb","usetls":false,"tls":""},{"id":"d2adcd4a.3d58f","type":"mqtt-broker","z":"","name":"MQTT(CENTER) Broker","broker":"219.251.4.236","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"25b3ac9e.9ed5f4","type":"mqtt in","z":"d4a9e4d7.d2ec48","name":"Local MQTT Recv : #","topic":"#","qos":"0","broker":"9f219e3c.e6e46","x":143.5,"y":98,"wires":[["9d8027f.92debd8","231379e3.6cd7c6"]]},{"id":"9d8027f.92debd8","type":"function","z":"d4a9e4d7.d2ec48","name":"데이터 전처리","func":"var result = {\n    payload: JSON.stringify(msg)\n}\nreturn result;","outputs":1,"noerr":0,"x":340,"y":180,"wires":[["af87a7da.8ed668","896c9640.2d7fd8"]]},{"id":"733d8011.acc2e","type":"comment","z":"d4a9e4d7.d2ec48","name":"한국 지사 Broker : 219.251.4.237:1883","info":"","x":192.5,"y":51,"wires":[]},{"id":"896c9640.2d7fd8","type":"debug","z":"d4a9e4d7.d2ec48","name":"메세지 디버거","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":700,"y":180,"wires":[]},{"id":"231379e3.6cd7c6","type":"debug","z":"d4a9e4d7.d2ec48","name":"메세지 디버거","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":700,"y":100,"wires":[]},{"id":"b81ce03e.b44","type":"debug","z":"d4a9e4d7.d2ec48","name":"메세지 디버거","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":700,"y":260,"wires":[]},{"id":"af87a7da.8ed668","type":"MSSQL","z":"d4a9e4d7.d2ec48","mssqlCN":"f2efe6cb.ca58e8","name":"t_mqtt_log테이블에 데이터 추가 쿼리","query":"insert into t_mqtt_log (CONTENTS) values (\n    '{{{payload}}}'\n)","outField":"","x":410,"y":260,"wires":[["b81ce03e.b44"]]},{"id":"bfa3a0f6.8b468","type":"mqtt in","z":"adb69215.3727a","name":"+/INSPT/+/+ __","topic":"+/INSPT/+/+","qos":"0","broker":"6b8aec03.743554","x":142.16668701171875,"y":806.0000410079956,"wires":[["157cec35.353fd4"]]},{"id":"157cec35.353fd4","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":338.16669845581055,"y":832.6668691635132,"wires":[["2bc9117c.ccb2ee"]]},{"id":"53d6c99.ac49338","type":"mqtt in","z":"adb69215.3727a","name":"+/INSPTDEV/+/+","topic":"+/INSPTDEV/+/+","qos":"0","broker":"6b8aec03.743554","x":142,"y":861.6667098999023,"wires":[["157cec35.353fd4"]]},{"id":"3576657f.c54c2a","type":"inject","z":"adb69215.3727a","name":"","topic":"","payload":"","payloadType":"date","repeat":"3600","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":250,"wires":[["b003628a.38386"]]},{"id":"b003628a.38386","type":"function","z":"adb69215.3727a","name":"YYYYMMDD","func":"Date.prototype.yyyymmdd = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n\n  return [this.getFullYear(),\n          (mm>9 ? '' : '0') + mm,\n          (dd>9 ? '' : '0') + dd\n         ].join('');\n};\n\nvar date = new Date();\ndate.yyyymmdd();\n\n//global.set(\"YYYYMMDD\", date.yyyymmdd());\nglobal.set(\"YYYYMMDD\", \"20180101\");\n\nreturn;","outputs":1,"noerr":0,"x":350,"y":250,"wires":[[]]},{"id":"88c1b025.12d23","type":"inject","z":"adb69215.3727a","name":"reset globals","topic":"thingspin","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":120,"wires":[["e94a6823.7fb7b8"]]},{"id":"e94a6823.7fb7b8","type":"function","z":"adb69215.3727a","name":"reset globals","func":"global.set(\"INSPPROP\", null);\nglobal.set(\"ACTINADV\", null);\n\nmsg.payload = \"global context reset!\";\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":120,"wires":[["49682169.6a632","c6a3465.9cd78b8"]]},{"id":"f8f51a31.6c6528","type":"comment","z":"adb69215.3727a","name":"[저장소 이름을 구분하기 위해 YYYYMMDD를 생성___]","info":"","x":210,"y":200,"wires":[]},{"id":"d5401c38.fe64","type":"comment","z":"adb69215.3727a","name":"[관리자용 내부변수 초기화______________________]","info":"","x":210,"y":60,"wires":[]},{"id":"e8a68ffb.25896","type":"comment","z":"adb69215.3727a","name":"[시험결과를 받아 DB 포맷으로 변경 ___________________________________]","info":"","x":290,"y":761.6666860580444,"wires":[]},{"id":"2bc9117c.ccb2ee","type":"function","z":"adb69215.3727a","name":"RECORDS","func":"//=========================================================\nvar YYYYMMDD = global.get(\"YYYYMMDD\");\nvar inspprop = global.get(\"INSPPROP\");\n\nif ((YYYYMMDD === null) || (inspprop === null)) {\n    return;\n}\n\nvar mesINSP = \"inspection.summary-\" + YYYYMMDD;\nvar mesDETL = 'inspection.detail-' + YYYYMMDD;\n\n//=========================================================\nvar details = msg.payload.details;\ndelete msg.payload.details;\n\nvar inspection = msg.payload;\n\nif(inspection.prodModel === null || inspection.prodModel === undefined)\n{\n    //node.warn(\"inspection header include bad model code.\");\n    return null;\n}\n\n//=========================================================\ninspection = {\n    measurement: mesINSP,\n    tags: {\n        facility: inspection.pcID,\n        channel: inspection.channel,\n        model: inspection.prodModel,\n        pass: inspection.pass\n    },\n    fields: {\n        tuid: msg._msgid,\n        stime: inspection.startTime,\n        etime: inspection.endTime\n    }    \n};\n\n//=========================================================\nvar transaction = details.map(\n    function(point) {\n        var i = inspprop.get(point.iid);\n        if ( ( i === null) || ( i === undefined)) {\n            node.warn(point.iid);\n        }    \n        return {\n            measurement: mesDETL,\n            tags : {\n                facility: msg.payload.pcID,\n                channel: msg.payload.channel,\n                model: msg.payload.prodModel,\n                pass: point.pass,                \n                iid: point.iid,\n                inm: inspprop.get(point.iid).NAME || \"\"                \n            },\n            fields: {\n                tuid: msg._msgid,\n                val: point.val,\n                min: point.min,\n                max: point.max\n            }\n\n        };\n    }\n);\n\ntransaction.unshift(inspection);\n\n//=========================================================\nmsg.payload = transaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":831.6666860580444,"wires":[["69bb37cb.2f81a8","2e626d28.dc3912"]]},{"id":"69bb37cb.2f81a8","type":"link out","z":"adb69215.3727a","name":"inspection-results-out","links":["91c8e20d.ec771"],"x":1188.000036239624,"y":834.666690826416,"wires":[]},{"id":"80deef68.7157d","type":"comment","z":"adb69215.3727a","name":"To CPK 계산","info":"","x":1069.0000305175781,"y":835.666690826416,"wires":[]},{"id":"49682169.6a632","type":"link out","z":"adb69215.3727a","name":"reset-out","links":["3fd3dba8.5934f4"],"x":1180.0000343322754,"y":119.00000381469727,"wires":[]},{"id":"f62c24af.8213a8","type":"comment","z":"ad053556.7d5398","name":"[ 플로우 변수 초기화 ______________________]","info":"","x":190,"y":30,"wires":[]},{"id":"91c8e20d.ec771","type":"link in","z":"ad053556.7d5398","name":"inspection-result-receive","links":["69bb37cb.2f81a8"],"x":55,"y":270,"wires":[["dc32119.8f462f"]]},{"id":"dc32119.8f462f","type":"function","z":"ad053556.7d5398","name":"CEP","func":"var sa = global.get(\"stats-analysis\");\nvar sm = global.get(\"statistical-methods\");\nvar cepT = flow.get(\"cepTABLE\");\nif ((cepT === undefined) || cepT === null) {\n    node.warn(\"CEP context (cepT) being intialized...\");\n    cepT = new Map();\n    flow.set(\"cepTABLE\", cepT);\n}\n\nvar ruleT = global.get(\"ACTINADV\");\nif ((ruleT === undefined) || (ruleT === null)) {\n    node.error(\"A CEP (CPK calculation and monitoring & Continuos failure detection rule is not yet set!\");\n    ruleT = new Map();\n    global.set(\"ACTINADV\", ruleT);\n}\n\nvar head = msg.payload.shift();\nvar keyCH = head.tags.facility + \":\" + head.tags.channel;\nvar keyMD = keyCH + \":\" + head.tags.model;\n\nfunction __cpk(spec, v) {\n    var m = sa.mean(v);\n    var sigma = sa.stdev(v);\n\n    if(sigma === 0) {\n        sigma = 0.00000000000000000001;\n    }\n    var u = (spec.usl - m) / (3*sigma);\n    \n    var cpk;\n\n    if (spec.lsl === null) {\n        cpk = {\n            cpk: u,\n            cp: u/2\n        }\n    } else {\n        var l = (m - spec.lsl) / (3*sigma);\n        cpk = {\n            cpk: sm.min([l, u]),\n            cp: (spec.usl - spec.lsl) / (6*sigma)\n        }\n    }\n    \n    if( cpk.cp === null) cpk.cp = m;\n    if( cpk.cpk === null) cpk.cpk = m;\n\n    return cpk;\n}\n\nfunction _cpk(cep, k, so) {\n    \n    var saved = cep.get(k);\n\n    var val = saved.map(function(s) {\n        return s.fields.val;\n    });\n    \n    if (val.length <= 1) {\n        val.push(so.fields.val);\n    }\n    \n    var spec = {\n        lsl: so.fields.min, //sm.min(que.val),\n        usl: so.fields.max, //sm.max(que.val),\n    };\n\n    var c = __cpk(spec, val);\n\n    so.fields.cp = c.cp;\n    so.fields.cpk = c.cpk;\n    so.fields.usl = spec.usl;\n    so.fields.lsl = spec.lsl;\n    \n    return so;\n}\n\nfunction _store(cep, so) {\n    var key = so.tags.iid + \":\" + keyCH;\n    \n    so.key = key;\n    so.tags.fireCNF = false;\n    so.tags.fireCPK = false;\n    \n    so.fields.acc = (so.tags.pass === true) ? 0.0 : 1.0;\n    \n    var isin = cep.has(key);\n    if(!isin) {\n        cep.set(key, [so]);\n    } else {\n        var p = cep.get(key);\n        so.fields.acc = (so.tags.pass === true) ? 0.0 : parseInt(p[0].fields.acc) + 1.0;\n\n        if( p.length > 50 ) { // queue limit !\n            p.pop();\n        }\n        \n        p.unshift(so);\n        cep.set(key, p);\n    }\n\n    flow.set(\"cepTABLE\", cep);\n\n    return {key:key, so:so};\n}\n\n//===========================================================================\n// GET CPK\n//===========================================================================\nvar proc = msg.payload.map( (so) => {\n    var kso = _store(cepT, so);\n    \n    return _cpk(cepT, kso.key, kso.so);\n});\n\n//===========================================================================\n// GET ALRAM\n//===========================================================================\nfunction _alram(cep, rule, head, sos) {\n\n    var hits = [];\n\n    rule.forEach( (r) => {\n\n        //node.warn(r);\n        \n        \n        // 연속 뷸량 검출        \n        var cf = r.CONT_FAIL;\n        if (cf !== null && cf !== undefined) {\n            var cmax = parseInt(cf.COUNT);\n\n            sos.filter ( (so) => {\n                return !(r.INSPROP_IDX === 0 || r.INSPROP_IDX === so.tags.iid);\n            }).map( (so) => {\n                \n                so.fields.cmax = cmax;                \n                //node.warn(\"test:\" + cmax + \" with:\" +so.fields.acc + \" IN: \" + so.tags.facility + \":\" + so.tags.channel + \" : \" + so.fields.inm + \": \" + so.tags.model + \": \" + so.tags.pass);\n\n                if( so.fields.acc >= cmax) {\n                    switch(r.CONT_FAIL.ACTION) {\n                        case \"안함\" : {\n                            so.tags.alert = 0;\n                        } break;\n                        case \"알람\" : {\n                            so.tags.alert = 1;\n                        } break;\n                        case \"라인정지\" : {\n                            so.tags.alert = 2;\n                        } break;\n                    }\n                    so.tags.fireCNF = true;\n\n                    so.output = 1;\n                    hits.push(so);\n                    \n                    var p = cep.get(so.key);\n                    s = p.shift();\n                    s.fields.acc = 0; // accumulator clear\n                    p.unshift(s);\n                    cep.set(so.key, p);\n                }\n            })\n        }\n        \n        // CPK 위반 검출\n        var cpk = r.CPK;\n        if (cpk !== null && cpk !== undefined) {\n            sos.filter ( (so) => {\n                 return !(r.INSPROP_IDX === 0 || r.INSPROP_IDX === so.tags.iid);\n            }).map( (so) => {\n                if( (so.fields.cpk < cpk.LSL) || (so.fields.cpk > cpk.USL) ) {\n\n                    switch(r.CPK.ACTION) {\n                        case \"안함\" : {\n                            so.tags.alert = 0;\n                        } break;\n                        case \"알람\" : {\n                            so.tags.alert = 1;\n                        } break;\n                        case \"라인정지\" : {\n                            so.tags.alert = 2;\n                        } break;\n                    }\n\n                    so.output = 2;                    \n                    so.fields.lsl_min = cpk.LSL;\n                    so.fields.usl_max = cpk.USL;                    \n                    so.tags.fireCPK = true;\n                    hits.push(so);\n                }\n            });\n        }        \n    });\n    \n    return hits;\n}\nvar alram = _alram(cepT, ruleT, head, proc);\n\n//===========================================================================\n// MAIN RETURN\n//===========================================================================\n\nproc.unshift(head);\nmsg.payload = proc;\n\ndelete alram.key;\n\nvar a = {\n    legth: alram.length,\n    payload: alram,\n};\n\nreturn [msg, (a.legth === 0) ? null : a];","outputs":2,"noerr":0,"x":170,"y":270,"wires":[["6d719455.53c2dc"],["f8f8be5.c8c844"]]},{"id":"3fd3dba8.5934f4","type":"link in","z":"ad053556.7d5398","name":"reset-cpk-flow-in","links":["49682169.6a632"],"x":55,"y":80,"wires":[["20fa2615.aca4fa"]]},{"id":"20fa2615.aca4fa","type":"function","z":"ad053556.7d5398","name":"reset flow","func":"flow.set(\"cepTABLE\", null);\n\nmsg.payload = \"flow context reset!\";\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":80,"wires":[["28991bef.e15004"]]},{"id":"8b410c30.e6c5b","type":"inject","z":"ad053556.7d5398","name":"reset-flow","topic":"air\\SQLEXPRESS","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":120,"wires":[["20fa2615.aca4fa"]]},{"id":"79415cdd.aa1504","type":"comment","z":"ad053556.7d5398","name":"[시험결과 연속불량과 CPK 계산_____________]","info":"","x":200,"y":209,"wires":[]},{"id":"f8f8be5.c8c844","type":"function","z":"ad053556.7d5398","name":"알람 (경고, 라인정지)","func":"//=========================================================\nvar YYYYMMDD = global.get(\"YYYYMMDD\");\n\nif (YYYYMMDD === null) {\n    return;\n}\n\nvar cnf = \"alram.continuous.failures.detail-\" + YYYYMMDD;\nvar cpk = \"alram.cpk.detail-\" + YYYYMMDD;\n\nvar linestop = [];\nvar alerts = [];\n\nmsg.payload.map((a) => {\n    if( a.tags.alert === 2 ) { // 라인정지\n        linestop.push(a);\n        alerts.push(a);\n    } else if ( a.tags.alert === 1 ) {\n        alerts.push(a);\n    }\n\n    if(a.output === 1) {\n        a.measurement = cnf;\n    } else if (a.output === 2) {\n        a.measurement = cpk;\n    }\n\n    delete a.key;\n    delete a.output;\n});\n\nreturn [msg, alerts, linestop];","outputs":3,"noerr":0,"x":361.0000915527344,"y":359.00000762939453,"wires":[["48317cf4.590744"],["f3d07f8e.bd40d"],["1cf736e0.fbc429"]]},{"id":"6d719455.53c2dc","type":"link out","z":"ad053556.7d5398","name":"toDB-inspections","links":["24c7c289.2267be","2119c461.6910fc","25394e13.dcf9f2"],"x":824.0000247955322,"y":260.0000276565552,"wires":[]},{"id":"48317cf4.590744","type":"link out","z":"ad053556.7d5398","name":"toDB-aram-continuos-failures","links":["59dc8689.712408"],"x":825.0000190734863,"y":318.00000762939453,"wires":[]},{"id":"28991bef.e15004","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":728.1666870117188,"y":81.66667175292969,"wires":[]},{"id":"c6a3465.9cd78b8","type":"debug","z":"adb69215.3727a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":857.1666870117188,"y":118.66666984558105,"wires":[]},{"id":"e8d1b2cd.57e77","type":"mqtt in","z":"adb69215.3727a","name":"INSPPROP/#","topic":"INSPPROP/#","qos":"2","broker":"d2adcd4a.3d58f","x":111,"y":383,"wires":[["dae9bf8b.10d0e"]]},{"id":"1ff7974e.561709","type":"debug","z":"adb69215.3727a","name":"LOG: 검사항목","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":879.0000228881836,"y":440.0000123977661,"wires":[]},{"id":"59f82040.4ca0a","type":"mqtt in","z":"adb69215.3727a","name":"ACTINADV/#","topic":"ACTINADV/#","qos":"2","broker":"d2adcd4a.3d58f","x":106.0000228881836,"y":567.9999942779541,"wires":[["1978c978.0f53a7"]]},{"id":"d893c63d.428ed8","type":"debug","z":"adb69215.3727a","name":"LOG: 조치 룰","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":880.0000228881836,"y":677.0000200271606,"wires":[]},{"id":"ea55a10b.b1db4","type":"function","z":"adb69215.3727a","name":"Store in Global","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"INSPPROP\") {\n        msg.payload.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg.payload) !== true) {\n    return;\n}\n\nvar prop = msg.payload;\n\nvar map = global.get(\"INSPPROP\");\n\nif(map === null) {\n    map = new Map();\n}\n\nmap.set(prop.ID, prop);\n\nglobal.set(\"INSPPROP\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":681,"y":380,"wires":[["1ff7974e.561709"]]},{"id":"e59b6a9d.93c318","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":511,"y":380,"wires":[["ea55a10b.b1db4"]]},{"id":"a2e6abab.30ce48","type":"comment","z":"adb69215.3727a","name":"[검사항목리스트를 FLOW 컨텍스트에 저장_________]","info":"","x":211,"y":320,"wires":[]},{"id":"cdb4a45b.53b4f8","type":"comment","z":"adb69215.3727a","name":"[사전조치 항목: 연속불량 알림 계산 룰, CPK 계속 룰을  FLOW 컨텍스트에 저장]","info":"","x":292,"y":502.00001525878906,"wires":[]},{"id":"81249e99.8757e","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":486.0000228881836,"y":567.9999942779541,"wires":[["5b4d44a8.e4a37c"]]},{"id":"5b4d44a8.e4a37c","type":"function","z":"adb69215.3727a","name":"Store in Global","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"ACTINADV\") {\n        msg.payload.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg.payload) !== true) {\n    return;\n}\n\nvar prop = msg.payload;\n\nvar map = global.get(\"ACTINADV\");\n\nif(map === null) {\n    map = new Map();\n}\n\nmap.set(prop.ID, prop);\n\nglobal.set(\"ACTINADV\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":656.0000228881836,"y":567.9999942779541,"wires":[["d893c63d.428ed8"]]},{"id":"1978c978.0f53a7","type":"function","z":"adb69215.3727a","name":"removed ?","func":"var add = null;\nvar del = null;\n\nif (msg.payload === \"\") {\n    del = msg;\n} else {\n    add = msg;\n}\n\nreturn [add, del];","outputs":2,"noerr":0,"x":306.0000228881836,"y":567.9999942779541,"wires":[["81249e99.8757e"],["309e94a1.28cdac"]]},{"id":"309e94a1.28cdac","type":"function","z":"adb69215.3727a","name":"del","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"ACTINADV\") {\n        msg.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg) !== true) {\n    return;\n}\n\nvar map = global.get(\"ACTINADV\");\n\nif(map === null) {\n    map = new Map();\n}\n\nmap.delete(msg.ID);\n\nglobal.set(\"ACTINADV\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":503.0000534057617,"y":674.000020980835,"wires":[["d893c63d.428ed8"]]},{"id":"dae9bf8b.10d0e","type":"function","z":"adb69215.3727a","name":"removed ?","func":"var add = null;\nvar del = null;\n\nif (msg.payload === \"\") {\n    del = msg;\n} else {\n    add = msg;\n}\n\nreturn [add, del];","outputs":2,"noerr":0,"x":351,"y":383,"wires":[["e59b6a9d.93c318"],["6d5e0586.b7c46c"]]},{"id":"6d5e0586.b7c46c","type":"function","z":"adb69215.3727a","name":"del","func":"var token = msg.topic.split('/');\n\nfor ( var t in token ) {\n    if(token[t] == \"INSPPROP\") {\n        msg.ID = parseInt(token[parseInt(t)+1]);\n        break;\n    }\n}\n\nif ((\"ID\" in msg) !== true) {\n    return;\n}\n\nvar map = global.get(\"INSPPROP\");\n\nif(map === null) {\n    map = new Map();\n}\n\nmap.delete(msg.ID);\n\nglobal.set(\"INSPPROP\", map);\n\nreturn msg;","outputs":1,"noerr":0,"x":511,"y":440,"wires":[["1ff7974e.561709"]]},{"id":"2e626d28.dc3912","type":"debug","z":"adb69215.3727a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":879.166690826416,"y":833.6666927337646,"wires":[]},{"id":"cec1143c.7a0128","type":"mqtt in","z":"adb69215.3727a","name":"THINGSPIN/MODELS","topic":"THINGSPIN/MODELS","qos":"0","broker":"9f219e3c.e6e46","x":140,"y":1026,"wires":[["4f1b25f4.e3e27c"]]},{"id":"96ee076b.f6f788","type":"debug","z":"adb69215.3727a","name":"LOG: 모델리스트","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":904.0000228881836,"y":1026.0001125335693,"wires":[]},{"id":"4f1b25f4.e3e27c","type":"json","z":"adb69215.3727a","name":"","property":"payload","action":"","pretty":false,"x":424.00001525878906,"y":1027.0000305175781,"wires":[["96ee076b.f6f788"]]},{"id":"9a784a6e.1970b8","type":"comment","z":"adb69215.3727a","name":"[모델리스트_____________________________]","info":"","x":190,"y":963,"wires":[]},{"id":"f3d07f8e.bd40d","type":"link out","z":"ad053556.7d5398","name":"out-alerts","links":["ce250005.b957"],"x":826.166690826416,"y":354.6666965484619,"wires":[]},{"id":"1cf736e0.fbc429","type":"link out","z":"ad053556.7d5398","name":"out-linestop","links":["3ef68ee5.6d0df2"],"x":827.166690826416,"y":393.6666774749756,"wires":[]},{"id":"ae92f384.b60e6","type":"influxdb batch","z":"ad053556.7d5398","influxdb":"35d824ed.29e69c","precision":"ms","retentionPolicy":"","name":"","x":264.00006103515625,"y":613.0000267028809,"wires":[]},{"id":"25394e13.dcf9f2","type":"link in","z":"ad053556.7d5398","name":"in-toDB-inspections","links":["6d719455.53c2dc"],"x":46.00003433227539,"y":549.0000247955322,"wires":[["ae92f384.b60e6","7c80f997.9afb38"]]},{"id":"59dc8689.712408","type":"link in","z":"ad053556.7d5398","name":"in-toDB-aram-continuos-failures","links":["48317cf4.590744"],"x":46.00003433227539,"y":689.0000247955322,"wires":[["ae92f384.b60e6","a527502f.96cff"]]},{"id":"80cd1e64.90727","type":"comment","z":"ad053556.7d5398","name":"[ InfluxDB로 저장      ______________________]","info":"","x":192.00003051757812,"y":482.0000247955322,"wires":[]},{"id":"fc49c444.d7c088","type":"mqtt out","z":"ad053556.7d5398","name":"","topic":"","qos":"","retain":"","broker":"9f219e3c.e6e46","x":768.1667518615723,"y":549.6667108535767,"wires":[]},{"id":"bd4e2992.347548","type":"mqtt out","z":"ad053556.7d5398","name":"","topic":"","qos":"","retain":"","broker":"9f219e3c.e6e46","x":760.1667518615723,"y":680.666729927063,"wires":[]},{"id":"7c80f997.9afb38","type":"function","z":"ad053556.7d5398","name":"THINGSPIN/ASSEY/INSPECTIONS","func":"msg.topic = \"THINGSPIN/ASSEY/INSPECTIONS\"\nmsg.retain = false;\nmsg.qos = 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":310.1667175292969,"y":552.0000247955322,"wires":[["fc49c444.d7c088","72f61f61.be3f"]]},{"id":"a527502f.96cff","type":"function","z":"ad053556.7d5398","name":"THINGSPIN/ASSEY/ALRAM","func":"msg.topic = \"THINGSPIN/ASSEY/ALRAM\"\nmsg.retain = false;\nmsg.qos = 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":279.1667251586914,"y":684.0000305175781,"wires":[["bd4e2992.347548","eef4e449.65db28"]]},{"id":"72f61f61.be3f","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":913.1667442321777,"y":547.6667060852051,"wires":[]},{"id":"eef4e449.65db28","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":910.1668357849121,"y":678.6667308807373,"wires":[]},{"id":"67b23be6.a46dc4","type":"comment","z":"ad053556.7d5398","name":"[ MQTT로 발행  SCADA 소비 _______________]","info":"","x":794.0000915527344,"y":501.0000419616699,"wires":[]},{"id":"ce250005.b957","type":"link in","z":"ad053556.7d5398","name":"","links":["f3d07f8e.bd40d"],"x":52.16667175292969,"y":875.3333539962769,"wires":[["32373b91.68e474"]]},{"id":"3ef68ee5.6d0df2","type":"link in","z":"ad053556.7d5398","name":"","links":["1cf736e0.fbc429"],"x":57.16667366027832,"y":1007.3333606719971,"wires":[["98c5349e.054a88"]]},{"id":"9bbcdf93.1bd94","type":"comment","z":"ad053556.7d5398","name":"[ 경고 발행   ______ ______________________]","info":"","x":206,"y":816,"wires":[]},{"id":"de13087c.4bec48","type":"comment","z":"ad053556.7d5398","name":"[ 라인정지 발행 __________________________]","info":"","x":207.00000762939453,"y":947.0000267028809,"wires":[]},{"id":"32373b91.68e474","type":"function","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/ALERT","func":"msg.topic = \"THINGSPIN/EMERGENCY/ALERT\"\nmsg.payload = {\n    tags: msg.tags,    \n    fields: msg.fields,\n}\ndelete msg.tags;\ndelete msg.fields;\ndelete msg.measurement;\n\nreturn msg;","outputs":1,"noerr":0,"x":305.00000762939453,"y":874.0000257492065,"wires":[["11a336ba.d08349","7be02c34.e9cdf4"]]},{"id":"98c5349e.054a88","type":"function","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/LINESTOP","func":"msg.topic = \"THINGSPIN/EMERGENCY/LINESTOP\"\nmsg.payload = {\n    tags: msg.tags,    \n    fields: msg.fields,\n}\ndelete msg.tags;\ndelete msg.fields;\ndelete msg.measurement;\n\nreturn msg;","outputs":1,"noerr":0,"x":321.00000762939453,"y":1007.0000286102295,"wires":[["4cadef75.ac422","a57f0ad3.0d13a8"]]},{"id":"11a336ba.d08349","type":"mqtt out","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/ALERT","topic":"THINGSPIN/EMERGENCY/ALERT","qos":"0","retain":"true","broker":"9f219e3c.e6e46","x":858.0000228881836,"y":871.0000247955322,"wires":[]},{"id":"4cadef75.ac422","type":"mqtt out","z":"ad053556.7d5398","name":"THINGSPIN/EMERGENCY/LINESTOP","topic":"THINGSPIN/EMERGENCY/LINESTOP","qos":"0","retain":"false","broker":"9f219e3c.e6e46","x":869.0000228881836,"y":1004.0000295639038,"wires":[]},{"id":"7be02c34.e9cdf4","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1102.0000267028809,"y":869.0000247955322,"wires":[]},{"id":"a57f0ad3.0d13a8","type":"debug","z":"ad053556.7d5398","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1102.0000267028809,"y":1003.0000286102295,"wires":[]},{"id":"64badf23.a81ab","type":"comment","z":"ad053556.7d5398","name":"[ 경고]","info":"","x":908,"y":357,"wires":[]},{"id":"fc8c9560.021e38","type":"comment","z":"ad053556.7d5398","name":"[ 라인정지]","info":"","x":918,"y":395,"wires":[]},{"id":"91029ca7.1d7dd","type":"comment","z":"ad053556.7d5398","name":"[ 모든 계산된 결과 레코드]","info":"","x":963,"y":258,"wires":[]},{"id":"b8abd2cc.2d7d9","type":"comment","z":"ad053556.7d5398","name":"[ 모든 위반 레코드]","info":"","x":945,"y":313,"wires":[]}]